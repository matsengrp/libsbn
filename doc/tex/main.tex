\documentclass{article}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage[hidelinks]{hyperref}
% \usepackage{lineno}
% \linenumbers

\newcommand{\median}{\operatorname{median}}

\title{libsbn notes}
\author{Erick}

\begin{document}
\maketitle

\begin{abstract}
Abstract here.
\end{abstract}


\section*{Inference}

We want to maximize the ELBO

\[
L(\bm{\phi},{\bm{\psi}}) = \mathbb{E}_{q_{\bm{\phi},{\bm{\psi}}}(\tau, \bm{\theta})}\log\left(\frac{p(\bm{Y}|\tau, \bm{\theta}) p(\tau, \bm{\theta})}{q_{\bm{\phi}}(\tau)q_{\bm{\psi}}(\bm{\theta}|\tau)}\right) \leq \log p(\bm{Y}).
\]

In general, let $g_{\bm{\psi}}(\bm{\epsilon}|\tau)$ be the reparametrization function.

\[
L(\bm{\phi},{\bm{\psi}}) = \mathbb{E}_{
    q_{\bm{\phi}}(\tau,\bm{\epsilon})}
    \log\left(\frac{p(\bm{Y}|\tau,g_{\bm{\psi}}(\bm{\epsilon}|\tau))p(\tau, g_{\bm{\psi}}(\bm{\epsilon}|\tau))}{q_{\bm{\phi}}(\tau)q_{\bm{\psi}}(g_{\bm{\psi}}(\bm{\epsilon}|\tau)|\tau)}\right).
\]

Taking the derivative of the numerator of this expression with respect to a $\psi_i$ gives

\[
    \sum_b
    \left(
        \frac{\partial \log p(Y | \tau, \bm\theta)}{\partial \theta_b}
        +
        \frac{\partial \log p(\tau, \bm\theta)}{\partial \theta_b}
    \right)
    \frac{\partial g_{b,\psi}(\epsilon | \tau)}{\partial \psi_i}
\]
Given that $p(\tau, \bm\theta) = p(\tau) p(\bm\theta | \tau)$ this simplifies to
\[
    \sum_b
    \left(
        \frac{\partial \log p(Y | \tau, \bm\theta)}{\partial \theta_b}
        +
        \frac{\partial \log p(\bm\theta | \tau)}{\partial \theta_b}
    \right)
    \frac{\partial g_{b,\psi}(\epsilon | \tau)}{\partial \psi_i}
\]
The left hand term of the sum is the standard log phylogenetic gradient, while the right hand term is the derivative of the log branch length prior with respect to a specific branch.

In the case where the branch length prior $p(\bm\theta | \tau)$ is a product of terms $\prod_b p_b(\theta_b)$ this becomes very simple:
\[
    \frac{\partial \log p(\bm\theta | \tau)}{\partial \theta_b} =
    \frac{\partial \log p_b(\bm\theta_b)}{\partial \theta_b}.
\]

We will assume that $q_\psi(\bm\theta | \tau)$ factors as a product of terms across edges of the tree.


% \begin{figure}[h]
% \centering
% \includegraphics[width=0.35\textwidth]{figures/subsplit.pdf}
% \caption{\
% A subsplit structure.
% }
% \label{fig:subsplit}
% \end{figure}


\bibliographystyle{plain}
\bibliography{main}

\end{document}
